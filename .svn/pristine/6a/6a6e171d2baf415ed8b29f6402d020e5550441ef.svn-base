<template>
    <div class='main'>
        <div class="main-top">
            <div>
                <mu-select  @change='selectChange' v-model="value" full-width style="width:200px">
                    <mu-option ripple v-for="(item,index)  in orderListname"
                     :key="index" :label="item.label"
                     :value="item.value" ></mu-option>
                </mu-select>
                <mu-text-field v-model="keyword" style='width:300px;margin-bottom:0' @keyup.enter='enter' placeholder='请输入姓名或手机号'></mu-text-field>
            </div>
            <div>
                <mu-button small  color="primary" style='margin-top: 18px;background:#3b77e3;' @click='add'>新增</mu-button>
                <mu-button small  color="success" style='margin-top: 18px' @click='storeImport'>导入</mu-button>
                <mu-button small  color="primary" style='margin-top: 18px' @click='storeExport'>导出</mu-button>
            </div>
        </div>
        <ag-grid-vue style='width:100%;' class="ag-theme-balham is-full-widthag" 
        :gridOptions="grid"
        :rowData="rowData"
        :columnDefs="dataKey"
        :rowDoubleClicked="dblClick" 
        gridAutoHeight
        ></ag-grid-vue>
        <div v-if='loadingisshow' >
            <Spin >
                <mu-icon value="rotate_right" color="blue"  class="demo-spin-icon-load"></mu-icon>
                
                <div>Loading...</div>
            </Spin>
        </div>
        <mu-flex justify-content="center" class='page-box'>
            <mu-pagination raised circle 
            :current='current' :total="total" 
             :pageSize='pageSize' @change='changeSize'></mu-pagination>
        </mu-flex>

        <!--导入-->
    <Modal v-model="importisshow" width="700" :mask-closable='false' :closable='false' :title="$t('manage.warehouse.fileImport')"><!--文件导入-->
        <el-steps  :active="active"  :align-center='true' style='margin-left:120px'>
              <el-step :title="$t('manage.warehouse.fileImport')" ></el-step>
              <el-step :title="$t('manage.warehouse.fileY')" ></el-step>
              <el-step :title="$t('manage.warehouse.fileS')" ></el-step>
            </el-steps>

       <!--第一步-->
        <div style='width:100%;margin:20px auto;text-align:center;' v-if='oneStep'>
           <div style='width:100%;margin:20px auto;text-align:center;font-size:14px;font-weight:600;border-top:1px solid #e4e4e4'>
                <span style='display:block;margin: 20px auto 30px 0;'>{{$t('manage.warehouse.fileImport')}}</span><!--文件导入-->
            </div>
            <div style='width:100%;margin:20px auto;text-align:center;position:relative'>
                <div style='margin-left:-108px'>
                    <span>{{$t('manage.warehouse.filechoose')}}：</span><!--选择文件-->
                    <Input  disabled style='width:202px' v-model='url'></Input>
                    <div style='position:absolute;top: 0px;right:175px;height: 35px;width: 80px;overflow: hidden;'>
                        <el-upload
                        ref="upload"
                        :show-file-list='false'
                        class="upload-demo"
                        :action="actionUrl"
                        :on-progress='onprogress'
                        :on-success='success'
                        :before-upload='beforeAvatarUpload'
                        accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" >
                        <el-button size="small" type="primary" style='background:#169BD5'>
                        {{$t('manage.warehouse.upload')}}</el-button><!--点击上传-->

                        </el-upload>
                    </div>
                    <div v-if='loadingisshow' >
                        <Spin fix>
                            <mu-icon value="rotate_right" color="blue"  class="demo-spin-icon-load"></mu-icon>
                            
                            <div>Loading...</div>
                        </Spin>
                    </div>
                    <div v-if='errorisshow' class='importErrTxt'>{{error}}</div>
                </div>
            </div>
            <div style='margin-top:40px;display: flex;justify-content:space-between;;margin-bottom:-40px;font-size:14px;cursor:pointer'>
                <Button  type="ghost" style='margin-left:5px;border:none;background:#169BD5;color:#fff'>

                     <a :href="skuLoad" style='color:#fff' @click.stop='stopsku($event)'>
                     {{$t('manage.warehouse.fileD')}}</a>
                </Button>
                <span style="" @click="cancel">{{$t('public.cancel')}}</span><!--取消-->
            </div>
        </div>
        <!--第二步-->
         <div style='width:100%;margin:20px auto;text-align:center;' v-if='twoStep'>
            <div style='width:100%;margin:20px auto;text-align:center;position:relative'>
             
                <ag-grid-vue style='width:100%;height:240px;overflow:auto' class="ag-theme-balham is-full-widthag" 
                    :gridOptions="gridIm"
                    :rowData="importstoredataList"
                    :columnDefs="importstore"
                    gridAutoHeight
                    ></ag-grid-vue>
            </div>
            <div style='margin-top:40px;display: flex;justify-content:space-between;;margin-bottom:-40px;font-size:14px'>
                <div>共导入：<span style='color:blue'>{{importstoredataList.length}}</span> 条数据</div>
                <div>
                    <span style="color:#448AFF;font-size:14px" @click="gothree"><a>{{$t('public.sureBtn')}}</a></span><!--确认-->
                </div>
            </div>
         </div>
         
        <div slot="footer">

        </div>
    </Modal>
    </div>
</template>
<script>
import LoadUrl from '@/components/common/actionLoad'
import { AgGridVue } from "ag-grid-vue";
var autoGroupColumnDef = {
    headerName: "护理员",
    width: 200,
    field: 'caregiversName',
    valueGetter: function(params) {
        if (params.node.group) {
            return params.node.key;
        } else {
            return params.data[params.colDef.field];
        }
    },
    
    
};
export default {
    components:{
        AgGridVue
    },
    data(){
        return {
            value:1,
            orderListname:[
                
                {
                    label:"待审核",
                    value:1
                },
                
                {
                    label:"合约中",
                    value:3
                },
                {
                    label:"待恢复",
                    value:4
                },
                {
                    label:"中止",
                    value:5
                },
                {
                    label:"已终止",
                    value:9
                },
            ],
            loadingisshow:false,
            grid:{
                
                enableFilter:true,
                enableSorting:true,
                animateRows:true,
                rowHeight:40,
                // pagination: true,
                enableColResize:true,
                enableRangeSelection:true,
                //单行选中，"multiple" 多选（ctrl）,"single" 单选
                 rowSelection: 'multiple',
                 autoGroupColumnDef: autoGroupColumnDef,
            },
            gridIm:{
                enableFilter:true,
                enableSorting:true,
                animateRows:true,
                rowHeight:40,
                // pagination: true,
                enableColResize:true,
            },
            keyword:"",//搜索词
            rowId:"",//一行id
            current:1,
            uid: this.$store.state.common.token,
            dataKey: [
                {
                    headerName: "编号",
                    field: "code",
                    pinned: 'left',
                    width:180,
                },
                {
                    headerName:"护理员",
                    field:'caregiversName',
                    width:180,
                    filterParams:{newRowsAction: 'keep'}
                },
                {
                    headerName:"客户",
                    field: 'name',
                    width:180,
                },
                {
                    headerName:"性别",
                    field:'gender',
                    width:180,
                },
                {
                    headerName:"电话",//"电话",
                    field:'mobile',
                    width:180,
                },
                {
                    headerName:"街道",
                   
                    field: 'street',
                    width:180,
                },
                {
                    headerName:"居委会",
                    field: 'committees',
                    width:180,
                },
                {
                    headerName:"开始时间",
                    field: 'purposeStartTime',
                    width:180,
                },
                {
                    headerName:"结束",
                    field: 'purposeEndTime',
                    width:180,
                },
                {
                    headerName:"周一",
                    field:'monday',
                   
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }

                },
                {
                    headerName:"周二",
                    field:'tuesday',
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }
                },
                {
                    headerName:"周三",
                    field:'wednesday',
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }
                },
                {
                    headerName:"周四",
                    field:'thursday',
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }
                },
                {
                    headerName:"周五",
                    field:'friday',
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }
                },
                {
                    headerName:"周六",
                    field:'saturday',
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }
                },
                {
                    headerName:"周日",
                    field:'sunday',
                    width:180,
                    cellStyle: function(params) {
                        if (params.value=="服务") {
                            //mark police cells as red
                            return {color: '#fff', backgroundColor: 'green'};
                        } else {
                            return {color: '#fff', backgroundColor: '#ff0000'};;
                        }
                    }
                },
                {
                    headerName:"状态",
                    field: 'statusDesc',
                    pinned: 'right',
                    width:180,
                     cellStyle: function(params) {
                        switch(params.data.status){
                            case 1:
                                return {color:"#3B77E3"}
                            break;
                            case 3:
                                return {color:"#40ca98"}
                            break;
                            case 9:
                                return {color:"#d53c39"}
                            break;
                        }
                    }
                },
               
            ],
            rowData: [],
            total:0,
            pageSize:0,

            skuLoad:LoadUrl.actionLoad.customer,//商品导入模板
            loadingisshow:false,
            isshowtable:true,
            errorisshow:false,
            error:'',//导入失败的提示
            type:1,
            oneStep:true,//第一步显示
            twoStep:false,//第2步显示
            threeStep:false,//第3步显示
            active:1,//步数
            importisshow:false,//导入显示
            url:'',//选择文件后或名称
            
            //POST /aunt/import 导入
            actionUrl:LoadUrl.httpPrefix.Url+'aunt/import?uid='+this.$store.state.common.token,//导入地址
            //导入的商品文件数据key
            importstore:[
                {
                    headerName: "编号",
                    field: "code"
                },
                {
                    headerName:"姓名",
                    field: 'name',
                },
                {
                    headerName:"性别",
                    field:'genderDesc',
                },
                
                {
                    headerName:"手机号",//"电话",
                    field:'mobile',
                 
                },
                {
                    headerName:"家属姓名",
                   
                    field: 'familyName',
                },
                {
                    headerName:"家属电话",
                    field: 'emergencyCall',
                },
                {
                    headerName:"地址",//"地址",
                    field:'Raddress',
                },
                {
                    headerName:"状态",
                    field: 'statusDesc',
                },
            ],
            importstoredataList:[],//导入的仓库文件数据
        }
    },
    methods:{
        selectChange(s){
            this.value=s
            this.getUnitsList(this.value)
        },
        add(){
            this.$router.push('/addcustomer')
        },
        //回车搜索
        enter(){
            this.axios.get('/aunt/query?keyword='+this.keyword+'&uid=' + this.uid+'&length=500').then((res) => {
                let data = res.data;
                if(res.data.status == '200') {
                    this.rowData = data.rows;
                    this.pageSize = data.pageSize;
                    this.total = data.total;
                    this.rowData.forEach(x=>{
                        if(x.gender==1){    
                            x.gender="男"
                        }else{
                            x.gender="女"
                        }
                        this.getWeek(x)
                        x.Raddress=x.addressDetail
                        if(x.purposeEndTime=="NaN:NaN"){
                            x.purposeEndTime=''
                        }
                        if(x.purposeStartTime=="NaN:NaN"){
                            x.purposeStartTime=''
                        }
                    })
                }
            })
        },
        //转化星期
        getWeek(x){
            if(x.monday){
                x.monday="服务"
            }else{x.monday="休息"}
            if(x.tuesday){
                x.tuesday="服务"
            }else{x.tuesday="休息"}
            if(x.wednesday){
                 x.wednesday="服务"
            }else{x.wednesday="休息"}
            if(x.thursday){
                x.thursday="服务"
            }else{x.thursday="休息"}
            if(x.friday){
                 x.friday="服务"
            }else{x.friday="休息"}
            if(x.saturday){
                x.saturday="服务"
            }else{x.saturday="休息"}
            if(x.sunday){
                x.sunday="服务"
            }else{x.sunday="休息"}
        },
       //GET /aunt/query 客户清单
        getUnitsList(s){
            this.loadingisshow=true
            this.axios.get('/aunt/query?length=500&uid=' + this.uid+'&status='+s).then((res) => {
                
                if(res.data.status == '200') {
                    this.loadingisshow=false
                    let data = res.data;
                    this.rowData = data.rows;
                    this.pageSize = data.pageSize;
                    this.total = data.total;
                    this.rowData.forEach(x=>{
                        if(x.gender==1){    
                            x.gender="男"
                        }else{
                            x.gender="女"
                        }
                        this.getWeek(x)
                        x.Raddress=x.addressDetail
                        if(x.purposeEndTime=="NaN:NaN"){
                            x.purposeEndTime=''
                        }
                        if(x.purposeStartTime=="NaN:NaN"){
                            x.purposeStartTime=''
                        }
                       
                       
                    })
                }
            })
        },
        //页码改变
        changeSize(size){
            this.current=size
            this.axios.get('/aunt/query?length=500&offset='+this.current+'&uid=' + this.uid+'&status='+this.value).then((res) => {
                let data = res.data;
                if(res.data.status == '200') {
                    this.rowData = data.rows;
                    this.pageSize = data.pageSize;
                    this.total = data.total;
                    this.rowData.forEach(x=>{
                        if(x.gender==1){    
                            x.gender="男"
                        }else{
                            x.gender="女"
                        }
                        this.getWeek(x)
                        x.Raddress=x.addressDetail
                       
                        if(x.purposeEndTime=="NaN:NaN"){
                            x.purposeEndTime=''
                        }
                        if(x.purposeStartTime=="NaN:NaN"){
                            x.purposeStartTime=''
                        }

                    })
                }
            })
            
        },
        //点击一行
        clickRow(index, row, event){
            this.rowId=row.id
        },
        //双击一行
        dblClick(row){
            this.$router.push({
                path:'/addcustomer',
                query:{
                    id:row.data.id,
                    index:row.rowIndex,
                    s:row.data.status
                }
            })
        },
        //导入
            //下载阻止冒泡
            stopsku(event){
               event.stopPropagation()
            },
            //点击
            storeImport(){
                this.importisshow=true
                this.active=1
                this.oneStep=true//第一步显示
                this.twoStep=false//第2步隐藏
                this.threeStep=false//第3步隐藏
                this.url=''
                this.errorisshow=false
                this.error=''
                this.importstoredataList=[]
            },
            //取消
            cancel(){
                this.importisshow=false//弹框消失
                this.oneStep=true//第一步显示
                this.twoStep=false//第2步隐藏
                this.threeStep=false//第3步隐藏
                this.url=''
                this.errorisshow=false
                this.error=''
                this.importstoredataList=[]
            },
            //第一步
            importOne(){
                if(this.url==''){
                    this.errorisshow=true
                    this.error=this.$t('manage.warehouse.upmb')
                    return
                }else{
                    this.active=2
                    this.oneStep=false
                    this.twoStep=true

                }

            },
            //返回第一步
            goOneStep(){
                this.active=1
                this.oneStep=true
                this.twoStep=false
            },
            //进入第三
            gothree(){
               this.importisshow=false//弹框消失
                this.oneStep=true//第一步显示
                this.twoStep=false//第2步隐藏
                this.threeStep=false//第3步隐藏
                this.url=''
                this.errorisshow=false
                this.error=''
                this.importstoredataList=[]
            },
           
             //上传时
            onprogress(event, file, fileList){
                this.loadingisshow=true
            },
             //上传之前类型之前
            beforeAvatarUpload(file){

               var fileName=new Array()
                fileName =file.name.split('.');
                const extension = fileName[fileName.length-1] === 'xls'
                const extension2 =  fileName[fileName.length-1]=== 'xlsx'
                const isLt2M = file.size / 1024 / 1024 < 10
                if (!extension && !extension2) {

                    this.$notify({
                        title: "",
                        message:this.$t('finance.upTemplate'),//'上传模板只能是xls、xlsx格式!',
                        type: 'error',
                        position: 'bottom-right'
                    });
                }
                if (!isLt2M) {
                    this.$notify({
                        title: "",
                        message: this.$t('finance.upTemplateB'),//'上传模板大小不能超过 10MB!',
                        type: 'error',
                        position: 'bottom-right'
                    });
                }

             return extension || extension2 && isLt2M

            },
            //成功后的会掉
            success(response, file, fileList){
                 if(response.status==200){
                    this.error=this.$t('finance.upTemplateS')
                    this.errorisshow=true
                    this.url=file.name
                    console.log(response)
                    this.loadingisshow=false
                    this.importstoredataList=response.rows
                     this.importstoredataList.forEach(x=>{
                        if(x.gender==1){    
                            x.gender="男"
                        }else{
                            x.gender="女"
                        }
                        this.getWeek(x)
                        x.Raddress=x.province+x.city+x.district+x.addressDetail
                        x.serviceStartTime  = new Date(x.serviceStartTime).toTimeString().substring(0, 5)
                        x.serviceEndTime = new Date(x.serviceEndTime ).toTimeString().substring(0, 5)
                    })
                    this.active=2
                    this.oneStep=false
                    this.twoStep=true
                    this.getUnitsList(this.value)
                }else{
                    this.errorisshow=true
                    this.loadingisshow=false
                    this.error=response.errorMessage
                   //console.log(response)
                }
            },
            //导出GET /aunt/excel 导出
            storeExport(){
                this.axios.get('/aunt/excel?uid='+this.uid).then(res=>{
                    if(res.data!=null){
                        this.$notify({
                            title:"",//
                            message: res.data.errorMessage,
                            type: 'error',
                            position: 'bottom-right'
                        });
                    }else{
                        window.location.href=res.request.responseURL
                    }
                })
            },
        
    },
    mounted(){
        this.grid.api.sizeColumnsToFit()
        this.getUnitsList(this.value)
      
    }
}
</script>
<style scoped>
.main{
    width:100%
}
.main-top{
    width:100%;
    padding:0 20px;
    height:50px;
    line-break: 50px;
    display:flex;
    justify-content: space-between
}
.is-full-width{
    width: 100%;
    padding:0px 20px 20px 20px
}
.page-box{
    margin-bottom:120px
}
.rowStyle{
    background: red
}
</style>